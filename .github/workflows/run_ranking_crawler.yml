name: Run Crawler for Ranking

on:
  schedule:
    - cron: '20 13 * * *'  # 12분마다 실행
  workflow_dispatch:

jobs:
  run-crawler:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.x

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip

#    - name: Install Google Chrome
#      run: |
#        wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
#        sudo apt install ./google-chrome-stable_current_amd64.deb
#    - name: Install ChromeDriver
#      run: |
#        # Get the major version of Google Chrome
#        CHROME_VERSION=$(google-chrome --version | awk '{print $3}' | cut -d'.' -f1)
#
#        # Find the corresponding version of ChromeDriver
#        CHROMEDRIVER_VERSION=$(curl -s "https://chromedriver.storage.googleapis.com/LATEST_RELEASE_$CHROME_VERSION")
#
#        # Download and install ChromeDriver
#        wget "https://chromedriver.storage.googleapis.com/$CHROMEDRIVER_VERSION/chromedriver_linux64.zip"
#        unzip chromedriver_linux64.zip
#        sudo mv chromedriver /usr/local/bin/chromedriver
#        sudo chmod +x /usr/local/bin/chromedriver

    - name: Install ChromeDriver
      run: |
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee -a /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update -qqy
        sudo apt-get -qqy install google-chrome-stable
        CHROME_VERSION=$(google-chrome-stable --version)
        CHROME_FULL_VERSION=${CHROME_VERSION%%.*}
        CHROME_MAJOR_VERSION=${CHROME_FULL_VERSION//[!0-9]}
        sudo rm /etc/apt/sources.list.d/google-chrome.list
        export CHROMEDRIVER_VERSION=`curl -s https://chromedriver.storage.googleapis.com/LATEST_RELEASE_${CHROME_MAJOR_VERSION%%.*}`
        curl -L -O "https://chromedriver.storage.googleapis.com/${CHROMEDRIVER_VERSION}/chromedriver_linux64.zip"
        unzip chromedriver_linux64.zip && chmod +x chromedriver && sudo mv chromedriver /usr/local/bin
        export CHROMEDRIVER_VERSION=`curl -s https://chromedriver.storage.googleapis.com/LATEST_RELEASE_${CHROME_MAJOR_VERSION%%.*}`
        curl -L -O "https://chromedriver.storage.googleapis.com/${CHROMEDRIVER_VERSION}/chromedriver_linux64.zip"
        unzip chromedriver_linux64.zip && chmod +x chromedriver && sudo mv chromedriver /usr/local/bin
        chromedriver -version
        which chromedriver
        which google-chrome



    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_ranking.txt

    - name: Run Ranking Crawler
      env:
        APP_STORE_SYEONG_URL: ${{secrets.APP_STORE_SYEONG_URL}}
        SLACK_ALARMY_OAUTH_TOKEN: ${{secrets.SLACK_ALARMY_OAUTH_TOKEN}}
        SLACK_NOTIFICATIONS_CHANNEL_ID: ${{secrets.SLACK_NOTIFICATIONS_CHANNEL_ID}}
        JACOB_GH_USER_NAME: ${{secrets.JACOB_GH_USER_NAME}}
        JACOB_EMAIL: ${{secrets.JACOB_EMAIL}}
      run: python crawlers/ranking.py

    - name: Commit and push changes
      if: steps.changed-files.outputs.files_changed == 'true'
      run: |
        git config user.name "${{ secrets.JACOB_GH_USER_NAME }}"
        git config user.email "${{ secrets.JACOB_EMAIL }}"
        git add .
        git commit -m "Update data by workflows"
        git push https://${{ secrets.JACOB_GH_TOKEN }}@github.com/goodnodes/syeong_slack_bot.git